import { Injectable } from '@angular/core';
import { CrmStatus } from '@azavista/azavista-types';
import { BehaviorSubject, filter, firstValueFrom, map } from 'rxjs';
import { getWorkflowFactory, objectKeys } from './utils';
import * as i0 from "@angular/core";
export const getCrmStatusArray = () => {
    return objectKeys(CrmStatus).reduce((result, data) => {
        const crmStatus = CrmStatus[data];
        // eslint-disable-next-line eqeqeq
        if (crmStatus != undefined) {
            result.push(crmStatus);
        }
        return result;
    }, []);
};
export const crmStatusArray = getCrmStatusArray();
export class AzavistaWorkflowBuilderController {
    constructor() {
        this.dataMap = {};
        this.validityMap = {};
        this.initStatus$ = new BehaviorSubject(undefined);
    }
    async initFromProvider(dataProvider, eventId) {
        this.initStatus$.next('processing');
        this.eventId = eventId;
        this.dataProvider = dataProvider;
        this.init({
            workflows: await this.dataProvider.getAllWorkflowsForInit(eventId),
        });
        this.initStatus$.next('completed');
    }
    init(workflowData) {
        workflowData?.workflows.forEach(({ workflow, canvas }) => {
            this.addWorkflow(workflow.type, canvas, workflow);
        });
    }
    addWorkflow(type, canvas, data) {
        const factory = getWorkflowFactory(type, data);
        const createdData = { factory, ...canvas };
        this.dataMap[factory.getId()] = createdData;
        this.updateValidityMap(factory);
        this.save();
        return createdData;
    }
    updateWorkflowSettings(workflowId, data) {
        const { factory } = this.dataMap[workflowId];
        factory?.setValues(data);
        this.updateValidityMap(factory);
        this.save();
    }
    updateWorkflowCoordinate(workflowId, coordinate) {
        if (this.dataMap[workflowId]?.coordinate) {
            this.dataMap[workflowId].coordinate = coordinate;
            this.save();
        }
    }
    updateWorkflowNextWorkflow(outputType, sourceWorkflowId, targetWorkflowId) {
        if (!sourceWorkflowId) {
            return;
        }
        const { factory } = this.dataMap[sourceWorkflowId];
        factory?.setNextWorkflow(outputType, targetWorkflowId);
        this.updateValidityMap(factory);
        this.save();
    }
    updateWorkflowCanvas(workflowId, data) {
        if (this.dataMap[workflowId]) {
            this.dataMap[workflowId] = {
                ...this.dataMap[workflowId],
                ...data,
            };
            this.save();
        }
    }
    updateWorkflowProcess(workflowId, attribute, steps) {
        const { factory } = this.dataMap[workflowId];
        factory?.setCustomProcess(attribute, steps);
        this.updateValidityMap(factory);
        this.save();
    }
    isValidNextWorkflow(outputType, sourceWorkflowId, targetWorkflowId, isNewConnection = false) {
        const isTargetingSelf = sourceWorkflowId === targetWorkflowId;
        const sourceWorkflow = sourceWorkflowId
            ? this.dataMap[sourceWorkflowId]
            : null;
        const possibleWorkflows = sourceWorkflow?.factory.getPossibleWorkflows(outputType, Object.values(this.dataMap).map(({ factory }) => factory)) ?? [];
        const noOutputPin = possibleWorkflows.length === 0;
        const inValidTargetPin = targetWorkflowId && !possibleWorkflows.includes(targetWorkflowId);
        const isAddingMultipleConnection = !!(isNewConnection &&
            sourceWorkflow?.factory.getNextWorkflows()[outputType]);
        const isAddingEmptySourceConnection = isNewConnection && !sourceWorkflowId;
        if (noOutputPin ||
            inValidTargetPin ||
            isTargetingSelf ||
            isAddingMultipleConnection ||
            isAddingEmptySourceConnection) {
            this.log('isValidNextWorkflow', {
                isTargetingSelf,
                sourceWorkflow,
                possibleWorkflows,
                noOutputPin,
                inValidTargetPin,
                isAddingMultipleConnection,
                isAddingEmptySourceConnection,
            });
            return false;
        }
        return true;
    }
    deleteWorkflow(workflowId) {
        delete this.dataMap[workflowId];
        delete this.validityMap[workflowId];
        this.validityMap = {
            ...this.validityMap,
        };
        this.save();
    }
    getCurrentState() {
        const workflows = Object.entries(this.dataMap).reduce((result, [, { factory, coordinate, description, name }]) => {
            return result.concat([
                {
                    canvas: { coordinate, description, name },
                    workflow: factory.getWorkflow(),
                },
            ]);
        }, []);
        return { workflows };
    }
    async save() {
        this.log('save', {
            eventId: this.eventId,
            getCurrentState: this.getCurrentState(),
        });
        if (this.eventId) {
            this.dataProvider?.saveBuilderData(this.eventId, this.getCurrentState());
        }
    }
    async publish() {
        if (this.eventId) {
            this.dataProvider?.publishBuilderData(this.eventId, this.getCurrentState());
        }
    }
    async getInitializedWorkflowsMap() {
        return firstValueFrom(this.initStatus$.pipe(filter((status) => status === 'completed'), map(() => this.dataMap)));
    }
    log(logName, ...params) {
        if (this.isDebugCallback?.()) {
            console.groupCollapsed(logName);
            console.trace(params);
            console.groupEnd();
        }
    }
    updateValidityMap(factory) {
        this.validityMap = {
            ...this.validityMap,
            [factory.getId()]: factory.isValidated(),
        };
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.2.10", ngImport: i0, type: AzavistaWorkflowBuilderController, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "16.2.10", ngImport: i0, type: AzavistaWorkflowBuilderController, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.2.10", ngImport: i0, type: AzavistaWorkflowBuilderController, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }] });
export class WorkflowBuilderProviderAbstract {
    constructor(workflowController) {
        this.workflowController = workflowController;
    }
    async getBuilderData(eventId) {
        const unformattedWorkflows = await this.getAllWorkflowsForInit(eventId);
        return {
            draftConnectors: [],
            workflows: unformattedWorkflows,
        };
    }
    async getAllWorkflowsForDataSource(skippedWorkflowIds) {
        const dataMap = await this.workflowController.getInitializedWorkflowsMap();
        return Object.values(dataMap)
            .filter((data) => !skippedWorkflowIds.includes(data.factory.getId()))
            .map((data) => data.factory);
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.2.10", ngImport: i0, type: WorkflowBuilderProviderAbstract, deps: [{ token: AzavistaWorkflowBuilderController }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "16.2.10", ngImport: i0, type: WorkflowBuilderProviderAbstract }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.2.10", ngImport: i0, type: WorkflowBuilderProviderAbstract, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: AzavistaWorkflowBuilderController }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid29ya2Zsb3ctYnVpbGRlci5jb250cm9sbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvYXphdmlzdGEvd29ya2Zsb3ctYnVpbGRlci9zcmMvbGliL3dvcmtmbG93LWJ1aWxkZXIuY29udHJvbGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFZQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBWTNDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUNyRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sRUFBRSxjQUFjLEVBQUUsR0FBRyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBU3BFLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxVQUFVLEVBQUUsTUFBTSxTQUFTLENBQUM7O0FBY3pELE1BQU0sQ0FBQyxNQUFNLGlCQUFpQixHQUFHLEdBQWdCLEVBQUU7SUFDL0MsT0FBTyxVQUFVLENBQUMsU0FBUyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxFQUFFO1FBQ2pELE1BQU0sU0FBUyxHQUEyQixTQUFpQixDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2xFLGtDQUFrQztRQUNsQyxJQUFJLFNBQVMsSUFBSSxTQUFTLEVBQUU7WUFDeEIsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUMxQjtRQUNELE9BQU8sTUFBTSxDQUFDO0lBQ2xCLENBQUMsRUFBRSxFQUFpQixDQUFDLENBQUM7QUFDMUIsQ0FBQyxDQUFDO0FBQ0YsTUFBTSxDQUFDLE1BQU0sY0FBYyxHQUFHLGlCQUFpQixFQUFFLENBQUM7QUFLbEQsTUFBTSxPQUFPLGlDQUFpQztJQUg5QztRQUlJLFlBQU8sR0FBMEQsRUFBRSxDQUFDO1FBRXBFLGdCQUFXLEdBQStCLEVBQUUsQ0FBQztRQU03QyxnQkFBVyxHQUFHLElBQUksZUFBZSxDQUM3QixTQUFTLENB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LyogZXNsaW50LWRpc2FibGUgbm8tdXNlLWJlZm9yZS1kZWZpbmUgKi9cclxuaW1wb3J0IHtcclxuICAgIENhbnZhcyxcclxuICAgIENhbnZhc0l0ZW0sXHJcbiAgICBDYW52YXNXb3JrZmxvd0l0ZW0sXHJcbiAgICBDb29yZGluYXRlLFxyXG4gICAgT3V0cHV0UGluLFxyXG4gICAgV29ya2Zsb3dCdWlsZGVyLFxyXG4gICAgV29ya2Zsb3dTZXR0aW5ncyxcclxuICAgIFdvcmtmbG93VHlwZSxcclxuICAgIFdvcmtmbG93UHJvcGVydHlTZWxlY3QsXHJcbn0gZnJvbSAnQGF6YXZpc3RhL3dvcmtmbG93LWJ1aWxkZXItc2hhcmVkJztcclxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQge1xyXG4gICAgSUFzc2V0LFxyXG4gICAgSUVtYWlsQ2FtcGFpZ24sXHJcbiAgICBJRXZlbnQsXHJcbiAgICBJRXZlbnRTZXR0aW5ncyxcclxuICAgIElJbnRlZ3JhdGlvbixcclxuICAgIElQYWdlLFxyXG4gICAgSVRlYW0sXHJcbiAgICBJVXNlcixcclxuICAgIFN0ZXAsXHJcbn0gZnJvbSAnQGF6YXZpc3RhL3NlcnZpY2VsaWInO1xyXG5pbXBvcnQgeyBDcm1TdGF0dXMgfSBmcm9tICdAYXphdmlzdGEvYXphdmlzdGEtdHlwZXMnO1xyXG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIGZpbHRlciwgZmlyc3RWYWx1ZUZyb20sIG1hcCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBJRmllbGQgfSBmcm9tICdAYXphdmlzdGEvY29tcG9uZW50cy9zaGFyZWQnO1xyXG5pbXBvcnQge1xyXG4gICAgQ2FudmFzV29ya2Zsb3dGYWN0b3J5LFxyXG4gICAgV29ya2Zsb3dCdWlsZGVyRGF0YSxcclxuICAgIENhbnZhc0NvbnRyb2xsZXJEYXRhLFxyXG4gICAgQ2FudmFzV29ya2Zsb3dNYXAsXHJcbn0gZnJvbSAnLi90eXBlcyc7XHJcblxyXG5pbXBvcnQgeyBnZXRXb3JrZmxvd0ZhY3RvcnksIG9iamVjdEtleXMgfSBmcm9tICcuL3V0aWxzJztcclxuXHJcbmV4cG9ydCB0eXBlIFdvcmtmbG93UHJvcGVydHlEYXRhU291cmNlVHlwZSA9XHJcbiAgICBXb3JrZmxvd1Byb3BlcnR5U2VsZWN0WydkYXRhc291cmNlJ107XHJcblxyXG5leHBvcnQgdHlwZSBXb3JrZmxvd1Byb3BlcnR5RGF0YVNvdXJjZU1hcHMgPSB7XHJcbiAgICBGb3JtOiBJUGFnZTtcclxuICAgIFBhZ2U6IElQYWdlO1xyXG4gICAgRW1haWw6IElFbWFpbENhbXBhaWduO1xyXG4gICAgQ3JtU3RhdHVzOiBDcm1TdGF0dXM7XHJcbiAgICBXb3JrZmxvdzogQ2FudmFzV29ya2Zsb3dGYWN0b3J5PFdvcmtmbG93VHlwZT47XHJcbiAgICBQcm9maWxlUGFnZTogSVBhZ2U7XHJcbn07XHJcblxyXG5leHBvcnQgY29uc3QgZ2V0Q3JtU3RhdHVzQXJyYXkgPSAoKTogQ3JtU3RhdHVzW10gPT4ge1xyXG4gICAgcmV0dXJuIG9iamVjdEtleXMoQ3JtU3RhdHVzKS5yZWR1Y2UoKHJlc3VsdCwgZGF0YSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGNybVN0YXR1czogQ3JtU3RhdHVzIHwgdW5kZWZpbmVkID0gKENybVN0YXR1cyBhcyBhbnkpW2RhdGFdO1xyXG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBlcWVxZXFcclxuICAgICAgICBpZiAoY3JtU3RhdHVzICE9IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICByZXN1bHQucHVzaChjcm1TdGF0dXMpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfSwgW10gYXMgQ3JtU3RhdHVzW10pO1xyXG59O1xyXG5leHBvcnQgY29uc3QgY3JtU3RhdHVzQXJyYXkgPSBnZXRDcm1TdGF0dXNBcnJheSgpO1xyXG5cclxuQEluamVjdGFibGUoe1xyXG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxyXG59KVxyXG5leHBvcnQgY2xhc3MgQXphdmlzdGFXb3JrZmxvd0J1aWxkZXJDb250cm9sbGVyIHtcclxuICAgIGRhdGFNYXA6IENhbnZhc1dvcmtmbG93TWFwPENhbnZhc0NvbnRyb2xsZXJEYXRhPFdvcmtmbG93VHlwZT4+ID0ge307XHJcblxyXG4gICAgdmFsaWRpdHlNYXA6IENhbnZhc1dvcmtmbG93TWFwPGJvb2xlYW4+ID0ge307XHJcblxyXG4gICAgZGF0YVByb3ZpZGVyPzogV29ya2Zsb3dCdWlsZGVyUHJvdmlkZXJBYnN0cmFjdDtcclxuXHJcbiAgICBldmVudElkPzogc3RyaW5nO1xyXG5cclxuICAgIGluaXRTdGF0dXMkID0gbmV3IEJlaGF2aW9yU3ViamVjdDwnY29tcGxldGVkJyB8ICdwcm9jZXNzaW5nJyB8IHVuZGVmaW5lZD4oXHJcbiAgICAgICAgdW5kZWZpbmVkLFxyXG4gICAgKTtcclxuXHJcbiAgICBpc0RlYnVnQ2FsbGJhY2s/OiAoKSA9PiBib29sZWFuO1xyXG5cclxuICAgIGFzeW5jIGluaXRGcm9tUHJvdmlkZXIoXHJcbiAgICAgICAgZGF0YVByb3ZpZGVyOiBXb3JrZmxvd0J1aWxkZXJQcm92aWRlckFic3RyYWN0LFxyXG4gICAgICAgIGV2ZW50SWQ6IHN0cmluZyxcclxuICAgICkge1xyXG4gICAgICAgIHRoaXMuaW5pdFN0YXR1cyQubmV4dCgncHJvY2Vzc2luZycpO1xyXG4gICAgICAgIHRoaXMuZXZlbnRJZCA9IGV2ZW50SWQ7XHJcbiAgICAgICAgdGhpcy5kYXRhUHJvdmlkZXIgPSBkYXRhUHJvdmlkZXI7XHJcbiAgICAgICAgdGhpcy5pbml0KHtcclxuICAgICAgICAgICAgd29ya2Zsb3dzOiBhd2FpdCB0aGlzLmRhdGFQcm92aWRlci5nZXRBbGxXb3JrZmxvd3NGb3JJbml0KGV2ZW50SWQpLFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHRoaXMuaW5pdFN0YXR1cyQubmV4dCgnY29tcGxldGVkJyk7XHJcbiAgICB9XHJcblxyXG4gICAgaW5pdCh3b3JrZmxvd0RhdGE6IFdvcmtmbG93QnVpbGRlciB8IG51bGwpIHtcclxuICAgICAgICB3b3JrZmxvd0RhdGE/LndvcmtmbG93cy5mb3JFYWNoKCh7IHdvcmtmbG93LCBjYW52YXMgfSkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmFkZFdvcmtmbG93KHdvcmtmbG93LnR5cGUsIGNhbnZhcywgd29ya2Zsb3cpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGFkZFdvcmtmbG93PFcgZXh0ZW5kcyBXb3JrZmxvd1R5cGU+KFxyXG4gICAgICAgIHR5cGU6IFcsXHJcbiAgICAgICAgY2FudmFzOiBDYW52YXMsXHJcbiAgICAgICAgZGF0YT86IENhbnZhc1dvcmtmbG93SXRlbSxcclxuICAgICkge1xyXG4gICAgICAgIGNvbnN0IGZhY3RvcnkgPSBnZXRXb3JrZmxvd0ZhY3RvcnkodHlwZSwgZGF0YSk7XHJcbiAgICAgICAgY29uc3QgY3JlYXRlZERhdGEgPSB7IGZhY3RvcnksIC4uLmNhbnZhcyB9O1xyXG4gICAgICAgIHRoaXMuZGF0YU1hcFtmYWN0b3J5LmdldElkKCldID0gY3JlYXRlZERhdGE7XHJcbiAgICAgICAgdGhpcy51cGRhdGVWYWxpZGl0eU1hcDxXPihmYWN0b3J5KTtcclxuICAgICAgICB0aGlzLnNhdmUoKTtcclxuICAgICAgICByZXR1cm4gY3JlYXRlZERhdGE7XHJcbiAgICB9XHJcblxyXG4gICAgdXBkYXRlV29ya2Zsb3dTZXR0aW5nczxUIGV4dGVuZHMgV29ya2Zsb3dUeXBlPihcclxuICAgICAgICB3b3JrZmxvd0lkOiBzdHJpbmcsXHJcbiAgICAgICAgZGF0YTogV29ya2Zsb3dTZXR0aW5nczxUPixcclxuICAgICkge1xyXG4gICAgICAgIGNvbnN0IHsgZmFjdG9yeSB9ID0gdGhpcy5kYXRhTWFwW3dvcmtmbG93SWRdO1xyXG4gICAgICAgIGZhY3Rvcnk/LnNldFZhbHVlcyhkYXRhKTtcclxuICAgICAgICB0aGlzLnVwZGF0ZVZhbGlkaXR5TWFwPFQ+KGZhY3RvcnkpO1xyXG4gICAgICAgIHRoaXMuc2F2ZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHVwZGF0ZVdvcmtmbG93Q29vcmRpbmF0ZSh3b3JrZmxvd0lkOiBzdHJpbmcsIGNvb3JkaW5hdGU6IENvb3JkaW5hdGUpIHtcclxuICAgICAgICBpZiAodGhpcy5kYXRhTWFwW3dvcmtmbG93SWRdPy5jb29yZGluYXRlKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZGF0YU1hcFt3b3JrZmxvd0lkXS5jb29yZGluYXRlID0gY29vcmRpbmF0ZTtcclxuICAgICAgICAgICAgdGhpcy5zYXZlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHVwZGF0ZVdvcmtmbG93TmV4dFdvcmtmbG93KFxyXG4gICAgICAgIG91dHB1dFR5cGU6IE91dHB1dFBpbixcclxuICAgICAgICBzb3VyY2VXb3JrZmxvd0lkOiBzdHJpbmcgfCBudWxsLFxyXG4gICAgICAgIHRhcmdldFdvcmtmbG93SWQ6IHN0cmluZyB8IG51bGwsXHJcbiAgICApIHtcclxuICAgICAgICBpZiAoIXNvdXJjZVdvcmtmbG93SWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCB7IGZhY3RvcnkgfSA9IHRoaXMuZGF0YU1hcFtzb3VyY2VXb3JrZmxvd0lkXTtcclxuICAgICAgICBmYWN0b3J5Py5zZXROZXh0V29ya2Zsb3cob3V0cHV0VHlwZSwgdGFyZ2V0V29ya2Zsb3dJZCk7XHJcbiAgICAgICAgdGhpcy51cGRhdGVWYWxpZGl0eU1hcChmYWN0b3J5KTtcclxuICAgICAgICB0aGlzLnNhdmUoKTtcclxuICAgIH1cclxuXHJcbiAgICB1cGRhdGVXb3JrZmxvd0NhbnZhcyh3b3JrZmxvd0lkOiBzdHJpbmcsIGRhdGE6IFBhcnRpYWw8Q2FudmFzPikge1xyXG4gICAgICAgIGlmICh0aGlzLmRhdGFNYXBbd29ya2Zsb3dJZF0pIHtcclxuICAgICAgICAgICAgdGhpcy5kYXRhTWFwW3dvcmtmbG93SWRdID0ge1xyXG4gICAgICAgICAgICAgICAgLi4udGhpcy5kYXRhTWFwW3dvcmtmbG93SWRdLFxyXG4gICAgICAgICAgICAgICAgLi4uZGF0YSxcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgdGhpcy5zYXZlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHVwZGF0ZVdvcmtmbG93UHJvY2VzcyhcclxuICAgICAgICB3b3JrZmxvd0lkOiBzdHJpbmcsXHJcbiAgICAgICAgYXR0cmlidXRlOiBzdHJpbmcsXHJcbiAgICAgICAgc3RlcHM6IFN0ZXBbXSxcclxuICAgICkge1xyXG4gICAgICAgIGNvbnN0IHsgZmFjdG9yeSB9ID0gdGhpcy5kYXRhTWFwW3dvcmtmbG93SWRdO1xyXG4gICAgICAgIGZhY3Rvcnk/LnNldEN1c3RvbVByb2Nlc3MoYXR0cmlidXRlLCBzdGVwcyk7XHJcbiAgICAgICAgdGhpcy51cGRhdGVWYWxpZGl0eU1hcChmYWN0b3J5KTtcclxuICAgICAgICB0aGlzLnNhdmUoKTtcclxuICAgIH1cclxuXHJcbiAgICBpc1ZhbGlkTmV4dFdvcmtmbG93KFxyXG4gICAgICAgIG91dHB1dFR5cGU6IE91dHB1dFBpbixcclxuICAgICAgICBzb3VyY2VXb3JrZmxvd0lkOiBzdHJpbmcgfCBudWxsLFxyXG4gICAgICAgIHRhcmdldFdvcmtmbG93SWQ6IHN0cmluZyB8IG51bGwsXHJcbiAgICAgICAgaXNOZXdDb25uZWN0aW9uID0gZmFsc2UsXHJcbiAgICApOiBib29sZWFuIHtcclxuICAgICAgICBjb25zdCBpc1RhcmdldGluZ1NlbGYgPSBzb3VyY2VXb3JrZmxvd0lkID09PSB0YXJnZXRXb3JrZmxvd0lkO1xyXG4gICAgICAgIGNvbnN0IHNvdXJjZVdvcmtmbG93ID0gc291cmNlV29ya2Zsb3dJZFxyXG4gICAgICAgICAgICA/IHRoaXMuZGF0YU1hcFtzb3VyY2VXb3JrZmxvd0lkXVxyXG4gICAgICAgICAgICA6IG51bGw7XHJcbiAgICAgICAgY29uc3QgcG9zc2libGVXb3JrZmxvd3MgPVxyXG4gICAgICAgICAgICBzb3VyY2VXb3JrZmxvdz8uZmFjdG9yeS5nZXRQb3NzaWJsZVdvcmtmbG93cyhcclxuICAgICAgICAgICAgICAgIG91dHB1dFR5cGUsXHJcbiAgICAgICAgICAgICAgICBPYmplY3QudmFsdWVzKHRoaXMuZGF0YU1hcCkubWFwKCh7IGZhY3RvcnkgfSkgPT4gZmFjdG9yeSksXHJcbiAgICAgICAgICAgICkgPz8gW107XHJcbiAgICAgICAgY29uc3Qgbm9PdXRwdXRQaW4gPSBwb3NzaWJsZVdvcmtmbG93cy5sZW5ndGggPT09IDA7XHJcblxyXG4gICAgICAgIGNvbnN0IGluVmFsaWRUYXJnZXRQaW4gPVxyXG4gICAgICAgICAgICB0YXJnZXRXb3JrZmxvd0lkICYmICFwb3NzaWJsZVdvcmtmbG93cy5pbmNsdWRlcyh0YXJnZXRXb3JrZmxvd0lkKTtcclxuICAgICAgICBjb25zdCBpc0FkZGluZ011bHRpcGxlQ29ubmVjdGlvbiA9ICEhKFxyXG4gICAgICAgICAgICBpc05ld0Nvbm5lY3Rpb24gJiZcclxuICAgICAgICAgICAgc291cmNlV29ya2Zsb3c/LmZhY3RvcnkuZ2V0TmV4dFdvcmtmbG93cygpW291dHB1dFR5cGVdXHJcbiAgICAgICAgKTtcclxuICAgICAgICBjb25zdCBpc0FkZGluZ0VtcHR5U291cmNlQ29ubmVjdGlvbiA9XHJcbiAgICAgICAgICAgIGlzTmV3Q29ubmVjdGlvbiAmJiAhc291cmNlV29ya2Zsb3dJZDtcclxuICAgICAgICBpZiAoXHJcbiAgICAgICAgICAgIG5vT3V0cHV0UGluIHx8XHJcbiAgICAgICAgICAgIGluVmFsaWRUYXJnZXRQaW4gfHxcclxuICAgICAgICAgICAgaXNUYXJnZXRpbmdTZWxmIHx8XHJcbiAgICAgICAgICAgIGlzQWRkaW5nTXVsdGlwbGVDb25uZWN0aW9uIHx8XHJcbiAgICAgICAgICAgIGlzQWRkaW5nRW1wdHlTb3VyY2VDb25uZWN0aW9uXHJcbiAgICAgICAgKSB7XHJcbiAgICAgICAgICAgIHRoaXMubG9nKCdpc1ZhbGlkTmV4dFdvcmtmbG93Jywge1xyXG4gICAgICAgICAgICAgICAgaXNUYXJnZXRpbmdTZWxmLFxyXG4gICAgICAgICAgICAgICAgc291cmNlV29ya2Zsb3csXHJcbiAgICAgICAgICAgICAgICBwb3NzaWJsZVdvcmtmbG93cyxcclxuICAgICAgICAgICAgICAgIG5vT3V0cHV0UGluLFxyXG4gICAgICAgICAgICAgICAgaW5WYWxpZFRhcmdldFBpbixcclxuICAgICAgICAgICAgICAgIGlzQWRkaW5nTXVsdGlwbGVDb25uZWN0aW9uLFxyXG4gICAgICAgICAgICAgICAgaXNBZGRpbmdFbXB0eVNvdXJjZUNvbm5lY3Rpb24sXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuXHJcbiAgICBkZWxldGVXb3JrZmxvdyh3b3JrZmxvd0lkOiBzdHJpbmcpIHtcclxuICAgICAgICBkZWxldGUgdGhpcy5kYXRhTWFwW3dvcmtmbG93SWRdO1xyXG4gICAgICAgIGRlbGV0ZSB0aGlzLnZhbGlkaXR5TWFwW3dvcmtmbG93SWRdO1xyXG4gICAgICAgIHRoaXMudmFsaWRpdHlNYXAgPSB7XHJcbiAgICAgICAgICAgIC4uLnRoaXMudmFsaWRpdHlNYXAsXHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLnNhdmUoKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRDdXJyZW50U3RhdGUoKTogV29ya2Zsb3dCdWlsZGVyIHtcclxuICAgICAgICBjb25zdCB3b3JrZmxvd3MgPSBPYmplY3QuZW50cmllcyh0aGlzLmRhdGFNYXApLnJlZHVjZShcclxuICAgICAgICAgICAgKHJlc3VsdCwgWywgeyBmYWN0b3J5LCBjb29yZGluYXRlLCBkZXNjcmlwdGlvbiwgbmFtZSB9XSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdC5jb25jYXQoW1xyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FudmFzOiB7IGNvb3JkaW5hdGUsIGRlc2NyaXB0aW9uLCBuYW1lIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtmbG93OiBmYWN0b3J5LmdldFdvcmtmbG93KCksXHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIF0pO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBbXSBhcyBDYW52YXNJdGVtW10sXHJcbiAgICAgICAgKTtcclxuICAgICAgICByZXR1cm4geyB3b3JrZmxvd3MgfTtcclxuICAgIH1cclxuXHJcbiAgICBhc3luYyBzYXZlKCkge1xyXG4gICAgICAgIHRoaXMubG9nKCdzYXZlJywge1xyXG4gICAgICAgICAgICBldmVudElkOiB0aGlzLmV2ZW50SWQsXHJcbiAgICAgICAgICAgIGdldEN1cnJlbnRTdGF0ZTogdGhpcy5nZXRDdXJyZW50U3RhdGUoKSxcclxuICAgICAgICB9KTtcclxuICAgICAgICBpZiAodGhpcy5ldmVudElkKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZGF0YVByb3ZpZGVyPy5zYXZlQnVpbGRlckRhdGEoXHJcbiAgICAgICAgICAgICAgICB0aGlzLmV2ZW50SWQsXHJcbiAgICAgICAgICAgICAgICB0aGlzLmdldEN1cnJlbnRTdGF0ZSgpLFxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBhc3luYyBwdWJsaXNoKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmV2ZW50SWQpIHtcclxuICAgICAgICAgICAgdGhpcy5kYXRhUHJvdmlkZXI/LnB1Ymxpc2hCdWlsZGVyRGF0YShcclxuICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRJZCxcclxuICAgICAgICAgICAgICAgIHRoaXMuZ2V0Q3VycmVudFN0YXRlKCksXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIGdldEluaXRpYWxpemVkV29ya2Zsb3dzTWFwKCkge1xyXG4gICAgICAgIHJldHVybiBmaXJzdFZhbHVlRnJvbShcclxuICAgICAgICAgICAgdGhpcy5pbml0U3RhdHVzJC5waXBlKFxyXG4gICAgICAgICAgICAgICAgZmlsdGVyKChzdGF0dXMpID0+IHN0YXR1cyA9PT0gJ2NvbXBsZXRlZCcpLFxyXG4gICAgICAgICAgICAgICAgbWFwKCgpID0+IHRoaXMuZGF0YU1hcCksXHJcbiAgICAgICAgICAgICksXHJcbiAgICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBsb2cobG9nTmFtZTogc3RyaW5nLCAuLi5wYXJhbXM6IGFueVtdKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuaXNEZWJ1Z0NhbGxiYWNrPy4oKSkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmdyb3VwQ29sbGFwc2VkKGxvZ05hbWUpO1xyXG4gICAgICAgICAgICBjb25zb2xlLnRyYWNlKHBhcmFtcyk7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZ3JvdXBFbmQoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSB1cGRhdGVWYWxpZGl0eU1hcDxXIGV4dGVuZHMgV29ya2Zsb3dUeXBlPihcclxuICAgICAgICBmYWN0b3J5OiBDYW52YXNXb3JrZmxvd0ZhY3Rvcnk8Vz4sXHJcbiAgICApIHtcclxuICAgICAgICB0aGlzLnZhbGlkaXR5TWFwID0ge1xyXG4gICAgICAgICAgICAuLi50aGlzLnZhbGlkaXR5TWFwLFxyXG4gICAgICAgICAgICBbZmFjdG9yeS5nZXRJZCgpXTogZmFjdG9yeS5pc1ZhbGlkYXRlZCgpLFxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCB0eXBlIFdvcmtmbG93QnVpbGRlckRhdGFTb3VyY2VDYWxsYmFja3NPcHRpb25zID0ge1xyXG4gICAgc2tpcHBlZFdvcmtmbG93SWRzOiBzdHJpbmdbXTtcclxufTtcclxuXHJcbmV4cG9ydCB0eXBlIFByb2Nlc3NEYXRhU291cmNlQ2FsbGJhY2tzID0ge1xyXG4gICAgdXNlcnM6ICgpID0+IFByb21pc2U8SVVzZXJbXT47XHJcbiAgICBpbnRlZ3JhdGlvbnM6ICgpID0+IFByb21pc2U8T21pdDxJSW50ZWdyYXRpb24sICdzZXR0aW5ncyc+W10+O1xyXG4gICAgZ2V0RXZlbnRGaWVsZHM6IChldmVudElkOiBzdHJpbmcpID0+IFByb21pc2U8SUZpZWxkW10+O1xyXG4gICAgZXZlbnQ6IChldmVudElkOiBzdHJpbmcpID0+IFByb21pc2U8e1xyXG4gICAgICAgIGRldGFpbDogSUV2ZW50O1xyXG4gICAgICAgIHRlYW1zOiBJVGVhbVtdIHwgdW5kZWZpbmVkO1xyXG4gICAgICAgIHRlbXBsYXRlRXZlbnRzOiBJRXZlbnRbXSB8IHVuZGVmaW5lZDtcclxuICAgICAgICBwYXJ0aWNpcGFudEZpZWxkczogSUZpZWxkW107XHJcbiAgICAgICAgYXNzZXRzOiBJQXNzZXRbXTtcclxuICAgICAgICBzZXR0aW5nczogSUV2ZW50U2V0dGluZ3M7XHJcbiAgICB9PjtcclxufTtcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFdvcmtmbG93QnVpbGRlclByb3ZpZGVyQWJzdHJhY3Qge1xyXG4gICAgY29uc3RydWN0b3IoXHJcbiAgICAgICAgcHJvdGVjdGVkIHdvcmtmbG93Q29udHJvbGxlcjogQXphdmlzdGFXb3JrZmxvd0J1aWxkZXJDb250cm9sbGVyLFxyXG4gICAgKSB7fVxyXG5cclxuICAgIGFic3RyYWN0IGRhdGFTb3VyY2VDYWxsYmFja3M6IHtcclxuICAgICAgICBbZGF0YVNvdXJjZSBpbiBXb3JrZmxvd1Byb3BlcnR5RGF0YVNvdXJjZVR5cGVdOiAoXHJcbiAgICAgICAgICAgIGV2ZW50SWQ6IHN0cmluZyxcclxuICAgICAgICAgICAgb3B0aW9uczogV29ya2Zsb3dCdWlsZGVyRGF0YVNvdXJjZUNhbGxiYWNrc09wdGlvbnMsXHJcbiAgICAgICAgKSA9PiBQcm9taXNlPFdvcmtmbG93UHJvcGVydHlEYXRhU291cmNlTWFwc1tkYXRhU291cmNlXVtdPjtcclxuICAgIH07XHJcblxyXG4gICAgYWJzdHJhY3QgcHJvY2Vzc0RhdGFTb3VyY2VDYWxsYmFjazogUHJvY2Vzc0RhdGFTb3VyY2VDYWxsYmFja3M7XHJcblxyXG4gICAgYWJzdHJhY3QgZ2V0QWxsV29ya2Zsb3dzRm9ySW5pdChldmVudElkOiBzdHJpbmcpOiBQcm9taXNlPENhbnZhc0l0ZW1bXT47XHJcblxyXG4gICAgYWJzdHJhY3Qgc2F2ZUJ1aWxkZXJEYXRhKFxyXG4gICAgICAgIGV2ZW50SWQ6IHN0cmluZyxcclxuICAgICAgICBkYXRhOiBXb3JrZmxvd0J1aWxkZXIsXHJcbiAgICApOiBQcm9taXNlPHZvaWQ+O1xyXG5cclxuICAgIGFic3RyYWN0IHB1Ymxpc2hCdWlsZGVyRGF0YShcclxuICAgICAgICBldmVudElkOiBzdHJpbmcsXHJcbiAgICAgICAgZGF0YTogV29ya2Zsb3dCdWlsZGVyLFxyXG4gICAgKTogUHJvbWlzZTx2b2lkPjtcclxuXHJcbiAgICBhc3luYyBnZXRCdWlsZGVyRGF0YShldmVudElkOiBzdHJpbmcpOiBQcm9taXNlPFdvcmtmbG93QnVpbGRlckRhdGE+IHtcclxuICAgICAgICBjb25zdCB1bmZvcm1hdHRlZFdvcmtmbG93cyA9IGF3YWl0IHRoaXMuZ2V0QWxsV29ya2Zsb3dzRm9ySW5pdChldmVudElkKTtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBkcmFmdENvbm5lY3RvcnM6IFtdLFxyXG4gICAgICAgICAgICB3b3JrZmxvd3M6IHVuZm9ybWF0dGVkV29ya2Zsb3dzLFxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgYXN5bmMgZ2V0QWxsV29ya2Zsb3dzRm9yRGF0YVNvdXJjZShza2lwcGVkV29ya2Zsb3dJZHM6IHN0cmluZ1tdKSB7XHJcbiAgICAgICAgY29uc3QgZGF0YU1hcCA9XHJcbiAgICAgICAgICAgIGF3YWl0IHRoaXMud29ya2Zsb3dDb250cm9sbGVyLmdldEluaXRpYWxpemVkV29ya2Zsb3dzTWFwKCk7XHJcblxyXG4gICAgICAgIHJldHVybiBPYmplY3QudmFsdWVzKGRhdGFNYXApXHJcbiAgICAgICAgICAgIC5maWx0ZXIoXHJcbiAgICAgICAgICAgICAgICAoZGF0YSkgPT4gIXNraXBwZWRXb3JrZmxvd0lkcy5pbmNsdWRlcyhkYXRhLmZhY3RvcnkuZ2V0SWQoKSksXHJcbiAgICAgICAgICAgIClcclxuICAgICAgICAgICAgLm1hcCgoZGF0YSkgPT4gZGF0YS5mYWN0b3J5KTtcclxuICAgIH1cclxufVxyXG4iXX0=