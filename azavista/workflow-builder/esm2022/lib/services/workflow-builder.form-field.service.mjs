import { Injectable } from '@angular/core';
import { FormArray, FormControl, FormGroup, Validators, } from '@angular/forms';
import { WORKFLOW_NAME_TRANSLATIONS, WORKFLOW_EXPLANATION_TRANSLATIONS, } from '../types';
import { crmStatusArray, } from '../workflow-builder.controller';
import { createFormGroupFromData, delay, mergeDeep } from '../utils';
import * as i0 from "@angular/core";
import * as i1 from "@azavista/components/shared";
import * as i2 from "@ngx-translate/core";
export class AzavistaWorkflowBuilderFormFieldService {
    constructor(sharedSvc, translateSvc) {
        this.sharedSvc = sharedSvc;
        this.translateSvc = translateSvc;
        this.getPageAttributeTranslation = (pages) => {
            return pages.map((page) => ({
                value: page.id,
                trans: {
                    [this.translateSvc.currentLang]: page.name,
                },
            }));
        };
        this.getWorkflowAttributeTranslations = (workflows, skippedId) => {
            return workflows.reduce((result, factory) => {
                const id = factory.getId();
                if (!skippedId?.includes(id)) {
                    const workflow = factory.getWorkflow();
                    result.push({
                        value: id,
                        trans: {
                            [this.translateSvc.currentLang]: workflow.type,
                        },
                    });
                }
                return result;
            }, []);
        };
        this.getEmailCampaignAttributeTranslations = (emails) => {
            return emails.map((email) => ({
                value: email.id,
                trans: {
                    [this.translateSvc.currentLang]: email.name,
                },
            }));
        };
        this.getCrmAttributeTranslations = () => {
            return crmStatusArray.map((crmStatus) => ({
                value: crmStatus,
                trans: {
                    [this.translateSvc.currentLang]: crmStatus,
                },
            }));
        };
        this.translationsMapCallback = {
            CrmStatus: this.getCrmAttributeTranslations,
            Email: this.getEmailCampaignAttributeTranslations,
            Form: this.getPageAttributeTranslation,
            Page: this.getPageAttributeTranslation,
            ProfilePage: this.getPageAttributeTranslation,
            Workflow: this.getWorkflowAttributeTranslations,
        };
        this.getCanvasDataFields = (workflowType) => {
            const baseField = {
                category: '',
                builtin: true,
                editable: true,
                mandatory_for_planners: true,
                schema: {
                    type: 'string',
                },
            };
            return [
                {
                    ...baseField,
                    id: 'name',
                    name: 'name',
                    label: this.sharedSvc.translate('NAME'),
                    placeholder: this.sharedSvc.translate(WORKFLOW_NAME_TRANSLATIONS[workflowType]),
                },
                {
                    ...baseField,
                    id: 'description',
                    name: 'description',
                    label: this.sharedSvc.translate('DESCRIPTION'),
                    placeholder: this.sharedSvc.translate(WORKFLOW_EXPLANATION_TRANSLATIONS[workflowType]),
                    component: "textarea" /* FieldComponentType.textarea */,
                },
            ];
        };
    }
    getFormGroupFromWorkflowFactory(properties, factory) {
        const formGroup = new FormGroup({});
        properties.forEach((property) => {
            formGroup.addControl(property.attribute, this.getFormControlFromWorkflowProperty(property, factory));
        });
        return formGroup;
    }
    getFormControlFromWorkflowProperty(property, factory) {
        const { type } = property;
        const workflowSettings = factory.getWorkflow().settings;
        const validators = property.mandatory ? Validators.required : [];
        const asyncValidators = async (
        // eslint-disable-next-line @typescript-eslint/no-unused-vars
        control) => {
            await delay(500);
            control.markAsDirty();
            control.markAsTouched();
            return factory.validateAttribute(property)
                ? null
                : { validatorError: control.value };
        };
        switch (type) {
            case 'multiselect': {
                return new FormArray(workflowSettings[property.attribute]?.map((value) => {
                    return new FormControl(value);
                }) ?? [], validators, asyncValidators);
            }
            case 'select':
            case 'boolean':
            case 'number':
            case 'text': {
                return new FormControl(workflowSettings[property.attribute], 
                // property.mandatory ? Validators.required : [],
                validators, asyncValidators);
            }
            case 'process': {
                return createFormGroupFromData(factory.getCustomProcess(property.attribute) ?? []);
            }
        }
    }
    async getFieldFromWorkflowProperty(property, provider, options) {
        const { attribute, schema, datasource, label, mandatory, type } = property;
        const baseField = {
            category: '',
            builtin: true,
            editable: true,
            id: attribute,
            name: attribute,
            label: this.sharedSvc.translate(label),
            mandatory_for_planners: mandatory,
        };
        switch (type) {
            case 'select': {
                const attributeTranslations = await this.getFieldDataSourceTranslations(datasource, provider, options);
                return {
                    ...baseField,
                    type: 'select',
                    schema: mergeDeep(schema ?? {}, {
                        type: 'string',
                        enum: attributeTranslations.map(({ value }) => value),
                    }),
                    attributeTranslations,
                };
            }
            case 'multiselect': {
                const attributeTranslations = await this.getFieldDataSourceTranslations(property.datasource, provider, options);
                return {
                    ...baseField,
                    type: 'multi-select',
                    schema: mergeDeep(schema ?? {}, {
                        type: 'array',
                        items: {
                            type: 'string',
                            enum: attributeTranslations.map(({ value }) => value),
                        },
                    }),
                    attributeTranslations,
                };
            }
            case 'boolean':
            case 'number':
            case 'text': {
                return {
                    ...baseField,
                    type: type,
                    schema: mergeDeep(schema ?? {}, {
                        type: type === 'text' ? 'string' : type,
                    }),
                };
            }
            case 'process': {
                return {
                    ...baseField,
                    type: 'boolean',
                    schema: {
                        type: 'boolean',
                    },
                };
            }
        }
    }
    async getFieldDataSourceTranslations(dataSource, provider, options) {
        const dataSourceCallback = provider.dataSourceCallbacks[dataSource];
        const dataSourceRows = await dataSourceCallback(options.eventId, {
            skippedWorkflowIds: [options.workflowId],
        });
        const translationsCallback = this.translationsMapCallback[dataSource];
        return translationsCallback(dataSourceRows);
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.2.10", ngImport: i0, type: AzavistaWorkflowBuilderFormFieldService, deps: [{ token: i1.AzavistaSharedService }, { token: i2.TranslateService }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "16.2.10", ngImport: i0, type: AzavistaWorkflowBuilderFormFieldService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.2.10", ngImport: i0, type: AzavistaWorkflowBuilderFormFieldService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: function () { return [{ type: i1.AzavistaSharedService }, { type: i2.TranslateService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid29ya2Zsb3ctYnVpbGRlci5mb3JtLWZpZWxkLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9hemF2aXN0YS93b3JrZmxvdy1idWlsZGVyL3NyYy9saWIvc2VydmljZXMvd29ya2Zsb3ctYnVpbGRlci5mb3JtLWZpZWxkLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQWUzQyxPQUFPLEVBR0gsU0FBUyxFQUNULFdBQVcsRUFDWCxTQUFTLEVBQ1QsVUFBVSxHQUNiLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEIsT0FBTyxFQUNILDBCQUEwQixFQUMxQixpQ0FBaUMsR0FHcEMsTUFBTSxVQUFVLENBQUM7QUFDbEIsT0FBTyxFQUlILGNBQWMsR0FDakIsTUFBTSxnQ0FBZ0MsQ0FBQztBQUN4QyxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxNQUFNLFVBQVUsQ0FBQzs7OztBQVVyRSxNQUFNLE9BQU8sdUNBQXVDO0lBaUVoRCxZQUNZLFNBQWdDLEVBQ2hDLFlBQThCO1FBRDlCLGNBQVMsR0FBVCxTQUFTLENBQXVCO1FBQ2hDLGlCQUFZLEdBQVosWUFBWSxDQUFrQjtRQWxFMUMsZ0NBQTJCLEdBQUcsQ0FDMUIsS0FBbUIsRUFDSSxFQUFFO1lBQ3pCLE9BQU8sS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztnQkFDeEIsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFHO2dCQUNmLEtBQUssRUFBRTtvQkFDSCxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLEVBQUUsSUFBSSxDQUFDLElBQUk7aUJBQzdDO2FBQ0osQ0FBQyxDQUFDLENBQUM7UUFDUixDQUFDLENBQUM7UUFFRixxQ0FBZ0MsR0FBRyxDQUMvQixTQUFnRCxFQUNoRCxT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NUIsSUFBSSxFQUFFLElBQUksS0FBSyxNQUFNLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsSUFBSTtxQkFDMUMsQ0FBUTtpQkFDWixDQUFDO2FBQ0w7WUFDRCxLQUFLLFNBQVMsQ0FBQyxDQUFDO2dCQUNaLE9BQU87b0JBQ0gsR0FBRyxTQUFTO29CQUNaLElBQUksRUFBRSxTQUFTO29CQUNmLE1BQU0sRUFBRTt3QkFDSixJQUFJLEVBQUUsU0FBUztxQkFDbEI7aUJBQ0osQ0FBQzthQUNMO1NBQ0o7SUFDTCxDQUFDO0lBRUQsS0FBSyxDQUFDLDhCQUE4QixDQUdoQyxVQUFhLEVBQ2IsUUFBeUMsRUFDekMsT0FBMEI7UUFFMUIsTUFBTSxrQkFBa0IsR0FBRyxRQUFRLENBQUMsbUJBQW1CLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDcEUsTUFBTSxjQUFjLEdBQUcsTUFBTSxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFO1lBQzdELGtCQUFrQixFQUFFLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQztTQUMzQyxDQUFDLENBQUM7UUFDSCxNQUFNLG9CQUFvQixHQUFHLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUN0RSxPQUFPLG9CQUFvQixDQUFDLGNBQWMsQ0FBQyxDQUFDO0lBQ2hELENBQUM7K0dBbFBRLHVDQUF1QzttSEFBdkMsdUNBQXVDLGNBRnBDLE1BQU07OzRGQUVULHVDQUF1QztrQkFIbkQsVUFBVTttQkFBQztvQkFDUixVQUFVLEVBQUUsTUFBTTtpQkFDckIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7XHJcbiAgICBBemF2aXN0YVNoYXJlZFNlcnZpY2UsXHJcbiAgICBGaWVsZENvbXBvbmVudFR5cGUsXHJcbiAgICBJQXR0cmlidXRlVHJhbnNsYXRpb24sXHJcbiAgICBJRmllbGQsXHJcbn0gZnJvbSAnQGF6YXZpc3RhL2NvbXBvbmVudHMvc2hhcmVkJztcclxuaW1wb3J0IHtcclxuICAgIFdvcmtmbG93UHJvcGVydHksXHJcbiAgICBXb3JrZmxvd1Byb3BlcnR5V2l0aFNjaGVtYSxcclxuICAgIFdvcmtmbG93U2V0dGluZ3MsXHJcbiAgICBXb3JrZmxvd1R5cGUsXHJcbn0gZnJvbSAnQGF6YXZpc3RhL3dvcmtmbG93LWJ1aWxkZXItc2hhcmVkJztcclxuaW1wb3J0IHsgSUVtYWlsQ2FtcGFpZ24gfSBmcm9tICdAYXphdmlzdGEvc2VydmljZWxpYic7XHJcbmltcG9ydCB7IFRyYW5zbGF0ZVNlcnZpY2UgfSBmcm9tICdAbmd4LXRyYW5zbGF0ZS9jb3JlJztcclxuaW1wb3J0IHtcclxuICAgIEFic3RyYWN0Q29udHJvbCxcclxuICAgIEFzeW5jVmFsaWRhdG9yRm4sXHJcbiAgICBGb3JtQXJyYXksXHJcbiAgICBGb3JtQ29udHJvbCxcclxuICAgIEZvcm1Hcm91cCxcclxuICAgIFZhbGlkYXRvcnMsXHJcbn0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xyXG5pbXBvcnQge1xyXG4gICAgV09SS0ZMT1dfTkFNRV9UUkFOU0xBVElPTlMsXHJcbiAgICBXT1JLRkxPV19FWFBMQU5BVElPTl9UUkFOU0xBVElPTlMsXHJcbiAgICBJQmFzaWNQYWdlLFxyXG4gICAgQ2FudmFzV29ya2Zsb3dGYWN0b3J5LFxyXG59IGZyb20gJy4uL3R5cGVzJztcclxuaW1wb3J0IHtcclxuICAgIFdvcmtmbG93QnVpbGRlclByb3ZpZGVyQWJzdHJhY3QsXHJcbiAgICBXb3JrZmxvd1Byb3BlcnR5RGF0YVNvdXJjZU1hcHMsXHJcbiAgICBXb3JrZmxvd1Byb3BlcnR5RGF0YVNvdXJjZVR5cGUsXHJcbiAgICBjcm1TdGF0dXNBcnJheSxcclxufSBmcm9tICcuLi93b3JrZmxvdy1idWlsZGVyLmNvbnRyb2xsZXInO1xyXG5pbXBvcnQgeyBjcmVhdGVGb3JtR3JvdXBGcm9tRGF0YSwgZGVsYXksIG1lcmdlRGVlcCB9IGZyb20gJy4uL3V0aWxzJztcclxuXHJcbnR5cGUgRGF0YVNvdXJjZU9wdGlvbnMgPSB7XHJcbiAgICBldmVudElkOiBzdHJpbmc7XHJcbiAgICB3b3JrZmxvd0lkOiBzdHJpbmc7XHJcbn07XHJcblxyXG5ASW5qZWN0YWJsZSh7XHJcbiAgICBwcm92aWRlZEluOiAncm9vdCcsXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBBemF2aXN0YVdvcmtmbG93QnVpbGRlckZvcm1GaWVsZFNlcnZpY2Uge1xyXG4gICAgZ2V0UGFnZUF0dHJpYnV0ZVRyYW5zbGF0aW9uID0gKFxyXG4gICAgICAgIHBhZ2VzOiBJQmFzaWNQYWdlW10sXHJcbiAgICApOiBJQXR0cmlidXRlVHJhbnNsYXRpb25bXSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHBhZ2VzLm1hcCgocGFnZSkgPT4gKHtcclxuICAgICAgICAgICAgdmFsdWU6IHBhZ2UuaWQhLFxyXG4gICAgICAgICAgICB0cmFuczoge1xyXG4gICAgICAgICAgICAgICAgW3RoaXMudHJhbnNsYXRlU3ZjLmN1cnJlbnRMYW5nXTogcGFnZS5uYW1lLFxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgIH0pKTtcclxuICAgIH07XHJcblxyXG4gICAgZ2V0V29ya2Zsb3dBdHRyaWJ1dGVUcmFuc2xhdGlvbnMgPSAoXHJcbiAgICAgICAgd29ya2Zsb3dzOiBDYW52YXNXb3JrZmxvd0ZhY3Rvcnk8V29ya2Zsb3dUeXBlPltdLFxyXG4gICAgICAgIHNraXBwZWRJZD86IHN0cmluZ1tdLFxyXG4gICAgKTogSUF0dHJpYnV0ZVRyYW5zbGF0aW9uW10gPT4ge1xyXG4gICAgICAgIHJldHVybiB3b3JrZmxvd3MucmVkdWNlKChyZXN1bHQsIGZhY3RvcnkpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgaWQgPSBmYWN0b3J5LmdldElkKCk7XHJcbiAgICAgICAgICAgIGlmICghc2tpcHBlZElkPy5pbmNsdWRlcyhpZCkpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHdvcmtmbG93ID0gZmFjdG9yeS5nZXRXb3JrZmxvdygpO1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goe1xyXG4gICAgICAgICAgICAgICAgICAgIHZhbHVlOiBpZCxcclxuICAgICAgICAgICAgICAgICAgICB0cmFuczoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBbdGhpcy50cmFuc2xhdGVTdmMuY3VycmVudExhbmddOiB3b3JrZmxvdy50eXBlLFxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgICAgICB9LCBbXSBhcyBJQXR0cmlidXRlVHJhbnNsYXRpb25bXSk7XHJcbiAgICB9O1xyXG5cclxuICAgIGdldEVtYWlsQ2FtcGFpZ25BdHRyaWJ1dGVUcmFuc2xhdGlvbnMgPSAoXHJcbiAgICAgICAgZW1haWxzOiBJRW1haWxDYW1wYWlnbltdLFxyXG4gICAgKTogSUF0dHJpYnV0ZVRyYW5zbGF0aW9uW10gPT4ge1xyXG4gICAgICAgIHJldHVybiBlbWFpbHMubWFwKChlbWFpbCkgPT4gKHtcclxuICAgICAgICAgICAgdmFsdWU6IGVtYWlsLmlkISxcclxuICAgICAgICAgICAgdHJhbnM6IHtcclxuICAgICAgICAgICAgICAgIFt0aGlzLnRyYW5zbGF0ZVN2Yy5jdXJyZW50TGFuZ106IGVtYWlsLm5hbWUsXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgfSkpO1xyXG4gICAgfTtcclxuXHJcbiAgICBnZXRDcm1BdHRyaWJ1dGVUcmFuc2xhdGlvbnMgPSAoKTogSUF0dHJpYnV0ZVRyYW5zbGF0aW9uW10gPT4ge1xyXG4gICAgICAgIHJldHVybiBjcm1TdGF0dXNBcnJheS5tYXAoKGNybVN0YXR1cykgPT4gKHtcclxuICAgICAgICAgICAgdmFsdWU6IGNybVN0YXR1cyxcclxuICAgICAgICAgICAgdHJhbnM6IHtcclxuICAgICAgICAgICAgICAgIFt0aGlzLnRyYW5zbGF0ZVN2Yy5jdXJyZW50TGFuZ106IGNybVN0YXR1cyxcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICB9KSk7XHJcbiAgICB9O1xyXG5cclxuICAgIHRyYW5zbGF0aW9uc01hcENhbGxiYWNrOiB7XHJcbiAgICAgICAgW2tleSBpbiBXb3JrZmxvd1Byb3BlcnR5RGF0YVNvdXJjZVR5cGVdOiAoXHJcbiAgICAgICAgICAgIHJvd3M6IEFycmF5PFdvcmtmbG93UHJvcGVydHlEYXRhU291cmNlTWFwc1trZXldPixcclxuICAgICAgICApID0+IElBdHRyaWJ1dGVUcmFuc2xhdGlvbltdO1xyXG4gICAgfSA9IHtcclxuICAgICAgICBDcm1TdGF0dXM6IHRoaXMuZ2V0Q3JtQXR0cmlidXRlVHJhbnNsYXRpb25zLFxyXG4gICAgICAgIEVtYWlsOiB0aGlzLmdldEVtYWlsQ2FtcGFpZ25BdHRyaWJ1dGVUcmFuc2xhdGlvbnMsXHJcbiAgICAgICAgRm9ybTogdGhpcy5nZXRQYWdlQXR0cmlidXRlVHJhbnNsYXRpb24sXHJcbiAgICAgICAgUGFnZTogdGhpcy5nZXRQYWdlQXR0cmlidXRlVHJhbnNsYXRpb24sXHJcbiAgICAgICAgUHJvZmlsZVBhZ2U6IHRoaXMuZ2V0UGFnZUF0dHJpYnV0ZVRyYW5zbGF0aW9uLFxyXG4gICAgICAgIFdvcmtmbG93OiB0aGlzLmdldFdvcmtmbG93QXR0cmlidXRlVHJhbnNsYXRpb25zLFxyXG4gICAgfTtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICBwcml2YXRlIHNoYXJlZFN2YzogQXphdmlzdGFTaGFyZWRTZXJ2aWNlLFxyXG4gICAgICAgIHByaXZhdGUgdHJhbnNsYXRlU3ZjOiBUcmFuc2xhdGVTZXJ2aWNlLFxyXG4gICAgKSB7fVxyXG5cclxuICAgIGdldEZvcm1Hcm91cEZyb21Xb3JrZmxvd0ZhY3RvcnkoXHJcbiAgICAgICAgcHJvcGVydGllczogV29ya2Zsb3dQcm9wZXJ0eVtdLFxyXG4gICAgICAgIGZhY3Rvcnk6IENhbnZhc1dvcmtmbG93RmFjdG9yeTxXb3JrZmxvd1R5cGU+LFxyXG4gICAgKSB7XHJcbiAgICAgICAgY29uc3QgZm9ybUdyb3VwID0gbmV3IEZvcm1Hcm91cCh7fSk7XHJcbiAgICAgICAgcHJvcGVydGllcy5mb3JFYWNoKChwcm9wZXJ0eSkgPT4ge1xyXG4gICAgICAgICAgICBmb3JtR3JvdXAuYWRkQ29udHJvbChcclxuICAgICAgICAgICAgICAgIHByb3BlcnR5LmF0dHJpYnV0ZSxcclxuICAgICAgICAgICAgICAgIHRoaXMuZ2V0Rm9ybUNvbnRyb2xGcm9tV29ya2Zsb3dQcm9wZXJ0eShwcm9wZXJ0eSwgZmFjdG9yeSksXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIGZvcm1Hcm91cCBhcyBGb3JtR3JvdXA7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0Rm9ybUNvbnRyb2xGcm9tV29ya2Zsb3dQcm9wZXJ0eTxcclxuICAgICAgICBEIGV4dGVuZHMgV29ya2Zsb3dQcm9wZXJ0eVdpdGhTY2hlbWFbJ2RhdGFzb3VyY2UnXSxcclxuICAgID4oXHJcbiAgICAgICAgcHJvcGVydHk6IFdvcmtmbG93UHJvcGVydHlXaXRoU2NoZW1hICYgeyBkYXRhc291cmNlOiBEIH0sXHJcbiAgICAgICAgZmFjdG9yeTogQ2FudmFzV29ya2Zsb3dGYWN0b3J5PFdvcmtmbG93VHlwZT4sXHJcbiAgICApOiBGb3JtQ29udHJvbCB8IEZvcm1BcnJheSB7XHJcbiAgICAgICAgY29uc3QgeyB0eXBlIH0gPSBwcm9wZXJ0eTtcclxuICAgICAgICBjb25zdCB3b3JrZmxvd1NldHRpbmdzID0gZmFjdG9yeS5nZXRXb3JrZmxvdygpLnNldHRpbmdzO1xyXG4gICAgICAgIGNvbnN0IHZhbGlkYXRvcnMgPSBwcm9wZXJ0eS5tYW5kYXRvcnkgPyBWYWxpZGF0b3JzLnJlcXVpcmVkIDogW107XHJcbiAgICAgICAgY29uc3QgYXN5bmNWYWxpZGF0b3JzOiBBc3luY1ZhbGlkYXRvckZuID0gYXN5bmMgKFxyXG4gICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXVudXNlZC12YXJzXHJcbiAgICAgICAgICAgIGNvbnRyb2w6IEFic3RyYWN0Q29udHJvbCxcclxuICAgICAgICApID0+IHtcclxuICAgICAgICAgICAgYXdhaXQgZGVsYXkoNTAwKTtcclxuICAgICAgICAgICAgY29udHJvbC5tYXJrQXNEaXJ0eSgpO1xyXG4gICAgICAgICAgICBjb250cm9sLm1hcmtBc1RvdWNoZWQoKTtcclxuICAgICAgICAgICAgcmV0dXJuIGZhY3RvcnkudmFsaWRhdGVBdHRyaWJ1dGUocHJvcGVydHkpXHJcbiAgICAgICAgICAgICAgICA/IG51bGxcclxuICAgICAgICAgICAgICAgIDogeyB2YWxpZGF0b3JFcnJvcjogY29udHJvbC52YWx1ZSB9O1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgc3dpdGNoICh0eXBlKSB7XHJcbiAgICAgICAgICAgIGNhc2UgJ211bHRpc2VsZWN0Jzoge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBGb3JtQXJyYXkoXHJcbiAgICAgICAgICAgICAgICAgICAgKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB3b3JrZmxvd1NldHRpbmdzW1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvcGVydHkuYXR0cmlidXRlIGFzIGtleW9mIFdvcmtmbG93U2V0dGluZ3M8XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyaW5nIHwgbnVsbFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBdIGFzIHN0cmluZ1tdXHJcbiAgICAgICAgICAgICAgICAgICAgKT8ubWFwKCh2YWx1ZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEZvcm1Db250cm9sKHZhbHVlKTtcclxuICAgICAgICAgICAgICAgICAgICB9KSA/PyBbXSxcclxuICAgICAgICAgICAgICAgICAgICB2YWxpZGF0b3JzLFxyXG4gICAgICAgICAgICAgICAgICAgIGFzeW5jVmFsaWRhdG9ycyxcclxuICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FzZSAnc2VsZWN0JzpcclxuICAgICAgICAgICAgY2FzZSAnYm9vbGVhbic6XHJcbiAgICAgICAgICAgIGNhc2UgJ251bWJlcic6XHJcbiAgICAgICAgICAgIGNhc2UgJ3RleHQnOiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEZvcm1Db250cm9sKFxyXG4gICAgICAgICAgICAgICAgICAgICh3b3JrZmxvd1NldHRpbmdzIGFzIGFueSlbcHJvcGVydHkuYXR0cmlidXRlXSxcclxuICAgICAgICAgICAgICAgICAgICAvLyBwcm9wZXJ0eS5tYW5kYXRvcnkgPyBWYWxpZGF0b3JzLnJlcXVpcmVkIDogW10sXHJcbiAgICAgICAgICAgICAgICAgICAgdmFsaWRhdG9ycyxcclxuICAgICAgICAgICAgICAgICAgICBhc3luY1ZhbGlkYXRvcnMsXHJcbiAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhc2UgJ3Byb2Nlc3MnOiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlRm9ybUdyb3VwRnJvbURhdGEoXHJcbiAgICAgICAgICAgICAgICAgICAgZmFjdG9yeS5nZXRDdXN0b21Qcm9jZXNzKHByb3BlcnR5LmF0dHJpYnV0ZSkgPz8gW10sXHJcbiAgICAgICAgICAgICAgICApIGFzIGFueTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBhc3luYyBnZXRGaWVsZEZyb21Xb3JrZmxvd1Byb3BlcnR5PFxyXG4gICAgICAgIEQgZXh0ZW5kcyBXb3JrZmxvd1Byb3BlcnR5V2l0aFNjaGVtYVsnZGF0YXNvdXJjZSddLFxyXG4gICAgPihcclxuICAgICAgICBwcm9wZXJ0eTogV29ya2Zsb3dQcm9wZXJ0eVdpdGhTY2hlbWEgJiB7IGRhdGFzb3VyY2U6IEQgfSxcclxuICAgICAgICBwcm92aWRlcjogV29ya2Zsb3dCdWlsZGVyUHJvdmlkZXJBYnN0cmFjdCxcclxuICAgICAgICBvcHRpb25zOiBEYXRhU291cmNlT3B0aW9ucyxcclxuICAgICk6IFByb21pc2U8SUZpZWxkPiB7XHJcbiAgICAgICAgY29uc3QgeyBhdHRyaWJ1dGUsIHNjaGVtYSwgZGF0YXNvdXJjZSwgbGFiZWwsIG1hbmRhdG9yeSwgdHlwZSB9ID1cclxuICAgICAgICAgICAgcHJvcGVydHk7XHJcbiAgICAgICAgY29uc3QgYmFzZUZpZWxkOiBQaWNrPFxyXG4gICAgICAgICAgICBJRmllbGQsXHJcbiAgICAgICAgICAgIHwgJ2NhdGVnb3J5J1xyXG4gICAgICAgICAgICB8ICdidWlsdGluJ1xyXG4gICAgICAgICAgICB8ICdlZGl0YWJsZSdcclxuICAgICAgICAgICAgfCAnaWQnXHJcbiAgICAgICAgICAgIHwgJ25hbWUnXHJcbiAgICAgICAgICAgIHwgJ2xhYmVsJ1xyXG4gICAgICAgICAgICB8ICdtYW5kYXRvcnlfZm9yX3BsYW5uZXJzJ1xyXG4gICAgICAgID4gPSB7XHJcbiAgICAgICAgICAgIGNhdGVnb3J5OiAnJyxcclxuICAgICAgICAgICAgYnVpbHRpbjogdHJ1ZSxcclxuICAgICAgICAgICAgZWRpdGFibGU6IHRydWUsXHJcbiAgICAgICAgICAgIGlkOiBhdHRyaWJ1dGUsXHJcbiAgICAgICAgICAgIG5hbWU6IGF0dHJpYnV0ZSxcclxuICAgICAgICAgICAgbGFiZWw6IHRoaXMuc2hhcmVkU3ZjLnRyYW5zbGF0ZShsYWJlbCksXHJcbiAgICAgICAgICAgIG1hbmRhdG9yeV9mb3JfcGxhbm5lcnM6IG1hbmRhdG9yeSxcclxuICAgICAgICB9O1xyXG4gICAgICAgIHN3aXRjaCAodHlwZSkge1xyXG4gICAgICAgICAgICBjYXNlICdzZWxlY3QnOiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVUcmFuc2xhdGlvbnMgPVxyXG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuZ2V0RmllbGREYXRhU291cmNlVHJhbnNsYXRpb25zKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhc291cmNlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlcixcclxuICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucyxcclxuICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICAuLi5iYXNlRmllbGQsXHJcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ3NlbGVjdCcsXHJcbiAgICAgICAgICAgICAgICAgICAgc2NoZW1hOiBtZXJnZURlZXAoc2NoZW1hID8/IHt9LCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICdzdHJpbmcnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbnVtOiBhdHRyaWJ1dGVUcmFuc2xhdGlvbnMubWFwKCh7IHZhbHVlIH0pID0+IHZhbHVlKSxcclxuICAgICAgICAgICAgICAgICAgICB9KSBhcyBhbnksXHJcbiAgICAgICAgICAgICAgICAgICAgYXR0cmlidXRlVHJhbnNsYXRpb25zLFxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYXNlICdtdWx0aXNlbGVjdCc6IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGF0dHJpYnV0ZVRyYW5zbGF0aW9ucyA9XHJcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5nZXRGaWVsZERhdGFTb3VyY2VUcmFuc2xhdGlvbnMoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BlcnR5LmRhdGFzb3VyY2UsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3ZpZGVyLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLFxyXG4gICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgICAgIC4uLmJhc2VGaWVsZCxcclxuICAgICAgICAgICAgICAgICAgICB0eXBlOiAnbXVsdGktc2VsZWN0JyxcclxuICAgICAgICAgICAgICAgICAgICBzY2hlbWE6IG1lcmdlRGVlcChzY2hlbWEgPz8ge30sIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2FycmF5JyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXM6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICdzdHJpbmcnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZW51bTogYXR0cmlidXRlVHJhbnNsYXRpb25zLm1hcChcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoeyB2YWx1ZSB9KSA9PiB2YWx1ZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgfSkgYXMgYW55LFxyXG4gICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZVRyYW5zbGF0aW9ucyxcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FzZSAnYm9vbGVhbic6XHJcbiAgICAgICAgICAgIGNhc2UgJ251bWJlcic6XHJcbiAgICAgICAgICAgIGNhc2UgJ3RleHQnOiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgICAgIC4uLmJhc2VGaWVsZCxcclxuICAgICAgICAgICAgICAgICAgICB0eXBlOiB0eXBlLFxyXG4gICAgICAgICAgICAgICAgICAgIHNjaGVtYTogbWVyZ2VEZWVwKHNjaGVtYSA/PyB7fSwge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiB0eXBlID09PSAndGV4dCcgPyAnc3RyaW5nJyA6IHR5cGUsXHJcbiAgICAgICAgICAgICAgICAgICAgfSkgYXMgYW55LFxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYXNlICdwcm9jZXNzJzoge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICAuLi5iYXNlRmllbGQsXHJcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2Jvb2xlYW4nLFxyXG4gICAgICAgICAgICAgICAgICAgIHNjaGVtYToge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAnYm9vbGVhbicsXHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgYXN5bmMgZ2V0RmllbGREYXRhU291cmNlVHJhbnNsYXRpb25zPFxyXG4gICAgICAgIEQgZXh0ZW5kcyBXb3JrZmxvd1Byb3BlcnR5RGF0YVNvdXJjZVR5cGUsXHJcbiAgICA+KFxyXG4gICAgICAgIGRhdGFTb3VyY2U6IEQsXHJcbiAgICAgICAgcHJvdmlkZXI6IFdvcmtmbG93QnVpbGRlclByb3ZpZGVyQWJzdHJhY3QsXHJcbiAgICAgICAgb3B0aW9uczogRGF0YVNvdXJjZU9wdGlvbnMsXHJcbiAgICApIHtcclxuICAgICAgICBjb25zdCBkYXRhU291cmNlQ2FsbGJhY2sgPSBwcm92aWRlci5kYXRhU291cmNlQ2FsbGJhY2tzW2RhdGFTb3VyY2VdO1xyXG4gICAgICAgIGNvbnN0IGRhdGFTb3VyY2VSb3dzID0gYXdhaXQgZGF0YVNvdXJjZUNhbGxiYWNrKG9wdGlvbnMuZXZlbnRJZCwge1xyXG4gICAgICAgICAgICBza2lwcGVkV29ya2Zsb3dJZHM6IFtvcHRpb25zLndvcmtmbG93SWRdLFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGNvbnN0IHRyYW5zbGF0aW9uc0NhbGxiYWNrID0gdGhpcy50cmFuc2xhdGlvbnNNYXBDYWxsYmFja1tkYXRhU291cmNlXTtcclxuICAgICAgICByZXR1cm4gdHJhbnNsYXRpb25zQ2FsbGJhY2soZGF0YVNvdXJjZVJvd3MpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldENhbnZhc0RhdGFGaWVsZHMgPSA8VCBleHRlbmRzIFdvcmtmbG93VHlwZT4oXHJcbiAgICAgICAgd29ya2Zsb3dUeXBlOiBULFxyXG4gICAgKTogSUZpZWxkW10gPT4ge1xyXG4gICAgICAgIGNvbnN0IGJhc2VGaWVsZDogUGljazxcclxuICAgICAgICAgICAgSUZpZWxkLFxyXG4gICAgICAgICAgICB8ICdjYXRlZ29yeSdcclxuICAgICAgICAgICAgfCAnYnVpbHRpbidcclxuICAgICAgICAgICAgfCAnZWRpdGFibGUnXHJcbiAgICAgICAgICAgIHwgJ21hbmRhdG9yeV9mb3JfcGxhbm5lcnMnXHJcbiAgICAgICAgICAgIHwgJ3NjaGVtYSdcclxuICAgICAgICA+ID0ge1xyXG4gICAgICAgICAgICBjYXRlZ29yeTogJycsXHJcbiAgICAgICAgICAgIGJ1aWx0aW46IHRydWUsXHJcbiAgICAgICAgICAgIGVkaXRhYmxlOiB0cnVlLFxyXG4gICAgICAgICAgICBtYW5kYXRvcnlfZm9yX3BsYW5uZXJzOiB0cnVlLFxyXG4gICAgICAgICAgICBzY2hlbWE6IHtcclxuICAgICAgICAgICAgICAgIHR5cGU6ICdzdHJpbmcnLFxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgIH07XHJcbiAgICAgICAgcmV0dXJuIFtcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgLi4uYmFzZUZpZWxkLFxyXG4gICAgICAgICAgICAgICAgaWQ6ICduYW1lJyxcclxuICAgICAgICAgICAgICAgIG5hbWU6ICduYW1lJyxcclxuICAgICAgICAgICAgICAgIGxhYmVsOiB0aGlzLnNoYXJlZFN2Yy50cmFuc2xhdGUoJ05BTUUnKSxcclxuICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyOiB0aGlzLnNoYXJlZFN2Yy50cmFuc2xhdGUoXHJcbiAgICAgICAgICAgICAgICAgICAgV09SS0ZMT1dfTkFNRV9UUkFOU0xBVElPTlNbd29ya2Zsb3dUeXBlXSxcclxuICAgICAgICAgICAgICAgICksXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIC4uLmJhc2VGaWVsZCxcclxuICAgICAgICAgICAgICAgIGlkOiAnZGVzY3JpcHRpb24nLFxyXG4gICAgICAgICAgICAgICAgbmFtZTogJ2Rlc2NyaXB0aW9uJyxcclxuICAgICAgICAgICAgICAgIGxhYmVsOiB0aGlzLnNoYXJlZFN2Yy50cmFuc2xhdGUoJ0RFU0NSSVBUSU9OJyksXHJcbiAgICAgICAgICAgICAgICBwbGFjZWhvbGRlcjogdGhpcy5zaGFyZWRTdmMudHJhbnNsYXRlKFxyXG4gICAgICAgICAgICAgICAgICAgIFdPUktGTE9XX0VYUExBTkFUSU9OX1RSQU5TTEFUSU9OU1t3b3JrZmxvd1R5cGVdLFxyXG4gICAgICAgICAgICAgICAgKSxcclxuICAgICAgICAgICAgICAgIGNvbXBvbmVudDogRmllbGRDb21wb25lbnRUeXBlLnRleHRhcmVhLFxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgIF07XHJcbiAgICB9O1xyXG59XHJcbiJdfQ==